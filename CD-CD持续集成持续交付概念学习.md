***

CI/CD学习

****

介绍

简单来说 CI（Continuous Intergration ）—— 持续集成，指开发人员能够频繁将代码集成到公共代码仓库的主分支中。而 CD（Continuous Deployment）——持续部署，以持续集成过程为其理论基石，其核心是部署一条流水线，实现应用程序从构建、部署、测试到发布这整个过程的自动化，从而提高软件的交付能力。

CI/CD 的核心思想就是部署一条自动化流水线，具体就是指实现应用程序从构建、部署、测试到发布这整个过程的自动化。将高度自动化的测试和部署以及全面的配置管理结合在一起，实现一键式软件发布。也就是说，我们只需要点击一下鼠标，就可将软件部署到任何目标环境，包括开发环境、测试环境或生产环境。

1.提交阶段：编译 单元测试、分析、 构建安装包

2.自动化 ：验收测试

3.自动化：容量测试

4.手工测试：演示 、探索性测试

这条流水线的工作特点就是，每次变更都会自动触发创建一个新的流水线实例 

常见问题的解决

1手工部署软件 ：很难不会发生错误、错误也很难追查、不可重复也不可靠

文档维护的问题：难以被其他人理解；手工部署依赖部署专家

手工部署脚本更难审核

无法保证实际部署时的成功率

2.开发完成后才向类生产环境部署

CI/CD对策时将测试部署和发布活动也纳入到开发过程

3.生产环境的手工配置管理

手工管理配置的问题同样在于极易出错，太多的配置细节可能出错，我们无法完全掌握生产环境的任何配置信息，不能重复地创建开发的应用程序所依赖的每个基础设施。而与之相反的，我们希望有以下这些能力：

- 我们应该有**记录或测试变更**的能力。几乎在每次发布的最后都会有一些变更，比如修改数据库的登录账户或者更新所用外部服务的URL。我们应该使用某种方法来引入此类变更，以便这些变更可以被记录并测试。
- 我们应该**完全掌握生产环境中的任何信息**的能力。生产环境中的每次变更都应该被记录下来，而且做到今后可以查阅。部署失败经常是因为某个人在上次部署时为生产环境打了补丁，但却没有将这个修改记录下来。
- 我们应该具有**重建生产环境**的能力。 
- 我们也应该有能力在部署出错时，通过同一个自动化过程将系统**回滚**到之前的版本

为了实现上述目标，CI/CD 的做法是将配置管理也纳入一个自动化的过程，对于测试环境、试运行环境和生产环境的所有方面，尤其是系统中的任何第三方元素的配置，都应该通过一个自动化的过程进行版本控制，这意味着操作系统、补丁级别、操作系统配置、应用程序所依赖的其他软件及其配置、基础设施的配置等都处于受控状态。变更首先会被提交到版本控制系统中，然后通过某个自动化过程对生产环境进行更新。



为了实现上述目标，CI/CD 的做法是将配置管理也纳入一个自动化的过程，对于测试环境、试运行环境和生产环境的所有方面，尤其是系统中的任何第三方元素的配置，都应该通过一个自动化的过程进行版本控制，这意味着操作系统、补丁级别、操作系统配置、应用程序所依赖的其他软件及其配置、基础设施的配置等都处于受控状态。变更首先会被提交到版本控制系统中，然后通过某个自动化过程对生产环境进行更新。



## 解决方案：自动化+频繁交付

这也正是 CI/CD 的核心思想

**首先为什么实现自动化是必要的呢？**

如果构建、部署、测试和发布流程不是自动化的，那它就是不可重复的。由于软件本身、系统配置、环境以及发布过程的不同，每次做完这些活动以后，其结果可能都会有所不同。如果每个步骤都是手工操作，那么出错的机会很大，而且无法确切地知道具体都做了什么。这意味着整个发布过程无法得到应有的控制来确保高质量。而实现自动化则可完美规避这些问题。

**其次频繁交付软件的重要性又体现在哪里呢？**

如果能够做到频繁发布，那么每个发布版本之间的差异会很小。这会大大减少与发布相关的风险，且更容易回滚，从而提升交付的速度与质量。




## 频繁且自动化交付软件应遵循的原则

**1.** **每次修改都应该进行反馈**

软件可看做由四个部分组成：可执行的代码、配置信息、运行环境和数据。修改其中任何一部分，都有可能导致软件的行为发生变化。所以我们要能够控制这四部分，对每次修改进行反馈，尽可能地测试每一次变更。

**需要控制的四大部分**

- 可执行代码

当修改了源代码后，可执行代码当然也就会随之发生变化。因此每当修改源代码后，都要进行构建和测试。为了能够控制这个流程，构建可执行代码并对其进行测试都应该是自动化的。每次提交都对应用程序进行构建并测试，这称作持续集成。之后的部署活动中都应该使用这个构建并测试后的可执行代码，无论是部署至测试环境，还是生产环境。此外，如果应用软件需要编译，应该确保在所有需要可执行代码的地方都使用在构建流程中已生成的这个，而不是再重新编译一次生成一个新的。

- 配置信息

对环境的任何修改都应该作为配置信息来管理。无论在什么环境下，对于应用程序配置的变更都应该被测试。如果用户自己安装软件的话，任何可能的配置项都应该在各种具有代表性的环境上测试。

- 运行环境

如果需要修改该应用程序所要被部署的运行环境，那么整个系统都应该在修改后的环境中进行测试。这包括对操作系统配置、该应用程序所依赖的软件集、网络配置，以及任何基础设施和外部系统的修改。

- 数据

如果是数据结构发生了变化，这些变化也同样要经过测试。

**反馈时应做到**

在检测到变化后，我们需要对变化进行反馈，尽可能地测试每一次变更，这些测试通常至少包括下面的检测：

- 创建可执行代码的流程必须是能奏效的。这用于验证源代码是否符合语法。 
- 软件的单元测试必须是成功的。这可以检查应用程序的行为是否与期望相同。 
- 软件应该满足一定的质量标准，比如测试覆盖率以及其他与技术相关的度量项。 
- 软件的功能验收测试必须是成功的。这可以检查应用是否满足业务验收条件， 交付了所期望的业务价值。 
- 软件的非功能测试必须是成功的。这可以检查应用程序是否满足用户对性能、 有效性、安全性等方面的要求。 
- 软件必须通过了探索性测试，并给客户以及部分用户做过演示。这些通常在一个手工测试环境上完成。此时，产品负责人可能认为软件功能还有缺失，我们自己也可能发现需要修复的缺陷，还要为其写自动化测试来避免回归测试。

**2.** **反馈速度要快**

反馈的速度也是关键。为了做到快速接受反馈，如果是手工人力来做就有着很大弊端。首先手工操作会花更长的时间，可能引入更多的错误，并且无法审计。另外，持续做手工构建、测试和部署非常枯燥而且有重复劳动，与人力资源利用率的准则相悖。我们应该将人力释放出来做更有价值的工作，将那些重复性的体力活交给机器来做。

要实现快速反馈，正确合理的做法是实现自动化。整个自动化流程里包含了全面的自动化测试套件，经过多轮测试后我们对软件更有信心。如果这些测试失败了，这个构建版本就不会再进入后续阶段。

为了确保对变更的快速反馈，此外我们还要注意开发软件的流程，特别是如何使用版本控制系统和如何组织代码。开发人员应该频繁提交代码到版本控制系统中，像管理大规模团队或分布式团队那样，将代码分成多个组件。在大多数情况下，应该避免使用分支。

**3.** **对反馈迅速做出反应**

当我们捕捉到变化并收到反馈时，应该及时对反馈做出反应，根据反馈来调整行动。在这个过程中应该做到：

**全员参与：**参与软件交付过程的所有人（包括开发人员、测试人员和运维人员、数据库管理员、 基础设施的专家以及管理者）都应该参与到这个反馈流程中，这是至关重要的。如果这些人无法到每天都在一起工作，就一定要常常碰头并一起探讨如何改进软件交付的流程。对于快速交付高质量的软件来说，基于持续改进的过程是非常关键的。迭代过程有助于为这类活动建立规律性，例如每个迭代至少开一次回顾会议，在会上每个人都应参与讨论如何在下一个迭代中改进交付过程。

**信息广播：**想要能够根据反馈来调整行动，就要对信息进行广播。使用一个大且可视的仪表盘，或者其他通知机制对于确保反馈送达到每一个人是极为重要的。

**纪律与计划：**当需要采取行动时，整个团队有责任停下他们手中的事情，来决定接下来采取哪些行动。在完成此事之后，团队才能继续自己的工作。

通过实现自动化和频繁交付软件，我们实现了软件的更快更好的交付，获得了很多益处，我们将能够验证变化，重现各种环境中的部署过程，在很大程度上减少产品出错的机会。由于发布过程本身已不再是一个障碍，我们可以部署软件变更，从而更快地获得商业利益，也让软件发布不再是一个充满压力的过程。在本系列的下一篇文章中，我们将了解到 CI/CD 所带来的更多意想不到的好处。

*** CI/CD 带来的好处

## **节省时间和金钱成本**

CI/CD 创建了一个可重复的、可靠的且可预见的发布流程，从而大大缩短了发布周期，使得新增功能和缺陷修复能更早与用户见面。这么做为我们节省下了巨大的金钱成本，还节省了包括建立和维护这样一个发布系统所需要的时间投入。

## **授权团队**

自动化流水线的一个巨大优势在于它具有“拉动效应”，它授权团队，把部署的权利下放到各个成员，使测试人员、运维人员或支持服务人员能够做到自服务，即他们可以自行决定将哪个版本的应用程序部署到哪个环境中。



**授权团队解决快速部署问题**

经验告诉我们，缩短发布时间的主要贡献者是那些在整个交付流程中，等待拿到应用程序的某个“好”版本的人。为了得到一个可用的版本，通常需要很多的电子邮件沟通、问题跟踪单，以及其他效率不高的沟通方式。假如是分布式交付团队的话，这一点就成了主要的低效之源。然而实现了部署流水线之后，这个问题就彻底解决了，因为每个人都能看到应该拿哪个版本部署到相应的环境中，而且只需要单击按钮就能完成部署。

**授权团队带来的其他众多好处**

在实际的软件开发中，不同的开发环境中运行着不同的版本，而不同角色的人工作在其上。能够轻松地将任意版本的软件部署到任意环境的能力能为我们带来很多好处：

- 测试人员可以选择性地部署较旧的版本，以验证新版本上的功能变化。
- 开发人员可以自己部署某个已发布的版本，用于重现缺陷。
- 运维人员可以自己选一个已知的正确版本，将其部署到生产环境中，实现灾难恢复。

部署工具为不同角色的人员提供了强大的灵活性，改变了以往传统低效的工作方式。总而言之，团队成员可以更好地控制工作节奏，从而改进工作质量，进而让应用程序的质量得以提高。他们之间的协作更加有效，无用的交互更少，可以更高效地工作，因为不需要花太多的时间等待可用的版本。 

## **减少错误**

在整个开发的生命周期中，我们可能在各个环境将错误引入到软件中。在最初的需求分析环节就有可能出错，比如客户提出错误的需求。如果需求分析人员将需求理解错了，那么开发人员也写出了到处都是缺陷的程序，此外还有由不良好的配置管理引入到生产环境的错误。而部署流水线则可以回避这里的由配置所导致的错误。


**什么是配置管理、以及配置管理的重要性**

当我们说配置管理时，指的是让你识别并控制一组完整信息的流程与机制，这些完整的信息包括比如数据库模式的正确版本、负载均衡器的正确配置信息、应用程序所依赖的 Web 服务的正确 URL 等。一个应用程序正确地工作除了需要正确版本的代码，还需要正确地配置信息，为了让应用良好工作我们必须管理好配置。

以具体的例子为例，服务器 A 的接池限数为100，而 B 的限数是120，这类问题通常看似无关紧要，但某些时候却是至关重要的。比如在业务交易最忙的时段里可能会有突发事故，可能正是由于配置项的不一致性导致的。这种情况通常发生在那些用于指定软件运行环境的配置项上，而且这种配置信息实际上经常通过代码指定新的执行路径。我们必须考虑到这类配置信息的更改，并且需要像对待代码一样，对代码运行的环境进行良好的定义与控制。修改数据库配置、应用服务器或 Web 服务器的话，肯定会让应用程序更快出故障，而且比直接修改编译器或源代码来得更快更容易。

**手工进行配置管理的缺点**

现实中依赖手工的配置管理存在很多问题。假如这类配置参数都是由手工配置和管理的话，难免会在那种重复性的工作中出现人为错误。在一些重要的位置上，只要一个简单的输入失误就可以让应用程序停止运行。编程语言可以通过语法检查来发现编译问题，单元测试可以验证代码中有没有输入错误。可是很少有哪种检查方式可以用于配置信息的验证，尤其是当这些配置信息是在某个控制台上直接输入的时候。此外，现在的软件系统常常是由几GB的内容组成，没有哪个团队或个人能够在没有机器帮助的情况下，轻松地查出这种大规模软件中的一小处不同。

相比极易出错的手工，为什么不选择机器呢？

**部署流水线的好处**

机器就可以规避手工容易出错的问题。将配置信息放在版本控制系统中会带来巨大的好处，当我们不小心修改了配置信息，版本控制系统就会发出提醒。这就至少消除了一种非常常见的错误源。当所有的配置信息都放在版本控制系统中以后，接下来就要消除“中间人”了，即让计算机直接使用这些配置信息，而不是再通过手工输入的方式来进行软件配置。

## **部署灵活性**

有了部署流水线，部署的灵活性也会大大提升，在一个全新环境上运行应用程序变成了一件相当简单的事。理想情况下，只要安装机器或虚拟镜像，然后配置一些与具体运行环境相关的特定选项，然后就可以使用自动化过程准备好新的部署环境，并选择指定的应用程序版本进行部署。

## **缓解压力**

交付项目往往是一件充满压力的事。当项目越临近发布日期，就越能感觉到压力，而压力也往往带来许多问题。而部署流水线可以大大减缓开发部署的压力。

如果发布只需要单击一下按钮，而且只需要等上几分钟，甚至几秒钟内就可以完成。另外，假如发生了非常糟糕的事情，只要花上相同的几分钟或几秒钟的时间就可以把刚部署的内容恢复到从前的老样子。而且软件发布周期总是很短，那么当前生产环境中的版本与新版本之间的差异应该非常小。如果上述设想都是事实的话，那么发布的风险一定会大大降低，发布是否成功的压力也将大大减少。减少压力的关键在于拥有一个我们前面所描述的自动化部署过程，并频繁地运行它，当部署失败后还能够快速恢复到原来状态。尽管刚开始做自动化时可能会很痛苦，但它会渐渐地变得容易起来，而它给项目和团队带来的好处是不可限量的。

以上这些便是 CI/CD 给软件交付所带来的的众多好处，这些好处让我们看到 CI/CD 无愧是如今的交付利器。
